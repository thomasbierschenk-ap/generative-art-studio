# Bug Fixes - October 25, 2025

## Issues Fixed

### 1. Control Panel Width Issue
**Problem:** The control panel on the left side was too narrow, causing the borders of the LabelFrames (Output Size, Parameters, Progress) to be cut off on the right side.

**Solution:** Increased both the outer panel width and the inner scrollable canvas width.

**Changes:**
- `src/gui/main_window.py`: 
  - Updated `minsize` parameter in `grid_columnconfigure` from 450 to 480
  - Updated `left_panel` Frame width from 450 to 480
  - Updated scrollable `canvas` width from 400 to 460 (this was the key fix!)

**Result:** All LabelFrame borders now display properly without being cut off.

---

### 2. Layer Mode Issues
**Problem 1:** When "Keep previous artwork (layer mode)" was checked and a second generation was started, the previous artwork would disappear during generation.

**Problem 2:** After the second generation completed, an error would occur: "Failed to generate artwork: attempt relative import beyond top-level package"

**Root Causes:**
1. The progress callback was showing only the new artwork during generation, not the merged result
2. The relative import `from ..generators.base import ArtworkData` was failing in the thread context

**Solution:** 
1. Created a wrapper progress callback (`layer_progress_callback`) that merges artwork during generation
2. Changed the import from relative (`from ..generators.base`) to absolute (`from generators.base`)
3. The wrapper callback ensures that during generation, the preview shows both the previous artwork AND the new artwork being drawn in real-time

**Changes:**
- `src/gui/main_window.py`: Completely rewrote `_generate_artwork()` method
  - Added conditional logic to check if layer mode is enabled
  - Created nested `layer_progress_callback` function that merges artwork before calling `_on_progress`
  - Changed imports to absolute imports to avoid relative import issues in threads
  - Added traceback printing for better debugging

**Result:** 
- Previous artwork now stays visible during new generation
- New artwork layers on top in real-time
- No import errors
- Layer mode works as expected

---

## Technical Details

### Layer Mode Implementation

The layer mode now works by:

1. **Before Generation:**
   - Check if layer mode checkbox is enabled
   - If enabled and there's existing artwork, store it as `previous_artwork`

2. **During Generation:**
   - If in layer mode, wrap the progress callback
   - The wrapper merges the previous artwork with the new artwork being generated
   - This merged result is passed to `_on_progress` for display
   - User sees both old and new artwork in real-time

3. **After Generation:**
   - Final merge of previous and new artwork
   - Store as `current_artwork`
   - Display the complete layered result

### Import Fix

Changed from:
```python
from ..generators.base import ArtworkData
```

To:
```python
from generators.base import ArtworkData
```

This works because:
- The main entry point (`src/main.py`) sets up the Python path correctly
- Absolute imports work reliably in threaded contexts
- No relative path resolution issues

---

## Testing Recommendations

1. **Panel Width:**
   - Open the GUI
   - Check that all LabelFrame borders are fully visible
   - Resize window to ensure layout remains correct

2. **Layer Mode:**
   - Generate first artwork with one color (e.g., black)
   - Check "Keep previous artwork (layer mode)"
   - Change the base color to something different (e.g., red)
   - Click Generate
   - Verify that:
     - Previous black artwork stays visible during generation
     - New red artwork appears on top in real-time
     - No error occurs when generation completes
     - Final result shows both artworks layered together

3. **Non-Layer Mode:**
   - Generate artwork
   - Uncheck "Keep previous artwork"
   - Click Generate again
   - Verify that previous artwork is replaced (not layered)

---

## Files Modified

- `src/gui/main_window.py`
  - Line ~48: Increased panel width from 450 to 480
  - Lines ~400-450: Rewrote `_generate_artwork()` method with layer mode support

---

## Future Enhancements

Potential improvements for layer mode:
- Add a "Clear Layers" button to remove all layers at once
- Show layer count in the UI
- Add opacity control for new layers
- Allow reordering or deleting individual layers
- Save layers as separate files or as a layered format
